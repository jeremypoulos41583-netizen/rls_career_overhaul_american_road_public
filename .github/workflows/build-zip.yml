name: Build ZIP on PR and Release

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - dev
  release:
    types: [published]

permissions:
  contents: read
  pull-requests: write
  actions: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: ${{ github.event_name == 'release' && 'write' || 'read' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Delete old artifacts
        if: github.event_name == 'pull_request'
        run: |
          PR_NUMBER="${{ github.event.number }}"
          ARTIFACT_PREFIX="rls_career_overhaul_american_road-pr-${PR_NUMBER}"

          echo "Looking for artifacts starting with: $ARTIFACT_PREFIX"

          ARTIFACTS_JSON=$(gh api repos/${{ github.repository }}/actions/artifacts --jq "[.artifacts[] | select(.name | startswith(\"$ARTIFACT_PREFIX\")) | {id: .id, name: .name}]" 2>/dev/null || echo "[]")

          ARTIFACT_COUNT=$(echo "$ARTIFACTS_JSON" | jq 'length')

          if [ "$ARTIFACT_COUNT" = "0" ] || [ -z "$ARTIFACTS_JSON" ] || [ "$ARTIFACTS_JSON" = "[]" ]; then
            echo "No existing artifacts found"
          else
            echo "Found $ARTIFACT_COUNT existing artifact(s), deleting..."
            echo "$ARTIFACTS_JSON" | jq -r '.[].id' | xargs -P 4 -I {} sh -c 'gh api repos/${{ github.repository }}/actions/artifacts/{} -X DELETE 2>/dev/null || true'
            echo "Old artifacts deleted"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload mod directories as artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: rls_career_overhaul_american_road-pr-${{ github.event.pull_request.number }}
          path: |
            gameplay/
            levels/
            lua/
            vehicles/
            scripts/
            ui/
          retention-days: 30
          if-no-files-found: error
          compression-level: 2

      - name: Create ZIP for release with versioned root folder
        id: create_zip
        if: github.event_name == 'release'
        run: |
          VERSION="${{ github.ref_name }}"
          ROOT_NAME="rls_career_overhaul_american_road_${VERSION}"
          mkdir -p "$ROOT_NAME"
          for dir in gameplay levels lua vehicles scripts ui; do
            [ -d "$dir" ] && cp -r "$dir" "$ROOT_NAME/"
          done
          zip -r "${ROOT_NAME}.zip" "$ROOT_NAME"
          echo "ROOT_NAME=${ROOT_NAME}" >> $GITHUB_OUTPUT
          echo "ZIP_NAME=${ROOT_NAME}.zip" >> $GITHUB_OUTPUT

      - name: Upload ZIP to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: ${{ steps.create_zip.outputs.ZIP_NAME }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old QA comments and post new one
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runId = context.runId;
            const repo = context.repo;
            const artifactName = 'rls_career_overhaul_american_road-pr-' + prNumber;

            // Delete old "Build Ready for QA" comments
            const comments = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber
            });

            console.log('Found ' + comments.data.length + ' total comments');

            for (const comment of comments.data) {
              if (comment.body && (comment.body.includes('Build Ready for QA') || comment.body.includes('üì¶'))) {
                console.log('Deleting comment ID: ' + comment.id);
                try {
                  await github.rest.issues.deleteComment({
                    owner: repo.owner,
                    repo: repo.repo,
                    comment_id: comment.id
                  });
                  console.log('Successfully deleted comment ' + comment.id);
                } catch (error) {
                  console.log('Failed to delete comment ' + comment.id + ': ' + error.message);
                }
              }
            }

            // Post new comment
            const downloadUrl = 'https://github.com/' + repo.owner + '/' + repo.repo + '/actions/runs/' + runId;
            const body = '## üì¶ Build Ready for QA\n\nA new build has been created for this PR.\n\n**[‚¨áÔ∏è Download ZIP Here](' + downloadUrl + ')**\n\n### Installation:\n1. Click the link above\n2. Scroll to the bottom to the "Artifacts" section\n3. Download `' + artifactName + '.zip`\n4. Place the downloaded .zip file directly in your BeamNG mods folder (do NOT extract)\n\n_Artifact will be available for 30 days._';

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: body
            });
